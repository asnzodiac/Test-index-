<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0b1220" />
  <title>AIX Security â€“ COK</title>

  <!-- Tailwind (required) -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <style>
:root{
  --bg:#fff; --text:#000; --hdr:#eee; --th:#333; --tht:#fff;
  --green:#c8f7c5; --yellow:#fff3b0; --red:#f7c5c5; --grey:#e0e0e0;
  --border:#ccc;
  --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
}
[data-theme="dark"]{
  --bg:#121212; --text:#fff; --hdr:#1f1f1f; --th:#2c2c2c; --tht:#fff;
  --green:#1f4d2b; --yellow:#5c4b00; --red:#5c1f1f; --grey:#333;
  --border:#444;
}

*{box-sizing:border-box}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:var(--font);
  font-size:13px;
}

/* ===== Controls ===== */
.controls-bar{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  justify-content:space-between;
  align-items:center;
  padding:8px;
  background:var(--hdr);
  border-bottom:1px solid var(--border);
  position:sticky;
  top:0;
  z-index:1000;
}

.controls-left,
.controls-right{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  align-items:center;
}

.btn{
  padding:5px 8px;
  font-size:.7rem;
  border-radius:6px;
  border:1px solid var(--border);
  background:var(--th);
  color:var(--tht);
  font-weight:600;
}

.btn.secondary{
  background:transparent;
  color:var(--text);
}

/* ===== Tabs ===== */
.tabs{
  display:flex;
  justify-content:center;
  gap:6px;
  padding:8px;
}

.tab-btn{
  padding:5px 10px;
  font-size:.75rem;
  border-radius:999px;
  border:1px solid var(--border);
  background:transparent;
  color:var(--text);
  opacity:.6;
}
.tab-btn.active{
  opacity:1;
  background:var(--hdr);
}

/* ===== Layout ===== */
.view-section{
  display:none;
  padding:0 6px 16px;
}
.view-section.active{
  display:block;
}

.split-view{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}
.split-col{
  flex:1;
  min-width:100%;
}

/* ===== Headings ===== */
h2{
  text-align:center;
  margin:8px 0;
  font-size:.9rem;
  background:var(--hdr);
  padding:6px;
  border-radius:6px;
}

/* ===== Table ===== */
.table-wrap{
  width:100%;
}

table{
  width:100%;
  table-layout:fixed;   /* KEY FOR FULL FIT */
  border-collapse:collapse;
  font-size:.72rem;
  background:var(--bg);
}

th,td{
  padding:6px 4px;
  text-align:center;
  word-wrap:break-word;
  white-space:normal;   /* ALLOW WRAP */
  border-right:1px solid var(--border);
}

th:last-child,
td:last-child{
  border-right:none;
}

/* Column margins visually */
tbody tr{
  border-bottom:1px solid var(--border);
}

/* Sticky header */
thead th{
  position:sticky;
  top:0;
  background:var(--th);
  color:var(--tht);
  z-index:5;
}

/* Status colors */
.onTime{background:var(--green)}
.delay{background:var(--yellow)}
.heavyDelay{background:var(--red)}
.cancelled{background:var(--grey)}

.flight-logo{
  height:12px;
  vertical-align:middle;
  margin-right:3px;
}

/* ===== Status Pill ===== */
.pill{
  display:inline-flex;
  align-items:center;
  gap:4px;
  border:1px solid var(--border);
  border-radius:999px;
  padding:3px 7px;
  font-size:.65rem;
}

.dot{
  width:7px;
  height:7px;
  border-radius:50%;
  background:#999;
}
.dot.ok{background:#22c55e}
.dot.warn{background:#f59e0b}
.dot.bad{background:#ef4444}

/* ===== MOBILE ONLY ===== */
@media(max-width:768px){

  body{font-size:12px;}

  .btn{font-size:.65rem;}

  table{font-size:.68rem;}

  th,td{padding:5px 3px;}

}
</style>


</head>
<body>
  <div class="controls-bar">
    <div class="controls-left">
      <button class="btn" id="loadEarlierBtn">Load Earlier Flights</button>
      <button class="btn secondary" id="proxyToggleBtn" title="Uses a CORS-friendly proxy (recommended on iPhone)">Proxy: Auto</button>
      <button class="btn secondary" id="themeToggle">Theme</button>
    </div>
    <div class="controls-right">
      <div class="pill" id="statusPill" title="Shows whether data is loading and which route is used (direct or proxy)">
        <span class="dot" id="statusDot"></span>
        <span id="statusText">Idle</span>
      </div>
      <button class="btn" id="notifyBtn">Notifications</button>
    </div>
    <div class="w-full hint" id="errorLine" style="display:none"></div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" id="flightsTab">ðŸ›¬ COK FLIGHTS ðŸ›«</button>
    <button class="tab-btn" id="turnTab">Turnaround Flights</button>
  </div>

  <!-- FLIGHTS VIEW -->
  <div id="flights-section" class="view-section active">
    <div class="split-view">
      <div class="split-col">
        <h2>ARRIVALS â€“ COK</h2>
        <div class="table-wrap">
          <table id="arrivals-table">
            <thead>
              <tr>
                <th>Flight</th><th>Reg</th><th>From</th>
                <th>ETA</th><th>STA</th><th>Aircraft</th><th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="split-col">
        <h2>DEPARTURES â€“ COK</h2>
        <div class="table-wrap">
          <table id="departures-table">
            <thead>
              <tr>
                <th>Flight</th><th>Reg</th><th>To</th>
                <th>ETD</th><th>STD</th><th>Aircraft</th><th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- TURNAROUND VIEW -->
  <div id="turnarounds-section" class="view-section">
    <h2>TURNAROUND MATCHES â€“ COK</h2>
    <div class="table-wrap">
      <table id="turnarounds-table">
        <thead>
          <tr>
            <th>Flight Pair</th><th>Reg</th><th>From</th><th>To</th>
            <th>ETA/ETD</th><th>STA/STD</th><th>Aircraft</th><th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="hint px-1">
      If iPhone/Safari blocks the Flightradar24 API (CORS), switch <b>Proxy: On</b>. For guaranteed reliability, use your own proxy (e.g., Cloudflare Worker) instead of public proxies.
    </div>
  </div>

<script>
  /* ================= CONFIG ================= */
  const AIRPORT = "cok";
  const BRANDFETCH_CLIENT_ID = "1idBLQ1djCDndBUmUVs";
  const baseUrl = `https://api.flightradar24.com/common/v1/airport.json?code=${AIRPORT}`;

  // IMPORTANT: Do NOT set a User-Agent header in browsers; it's a forbidden header
  // and can break on Safari/iOS.

  // Proxy modes: auto | on | off
  const LS_PROXY_MODE = 'cok_proxy_mode';
  let proxyMode = localStorage.getItem(LS_PROXY_MODE) || 'auto';

  let baseTimestamp = Math.floor(Date.now() / 1000);
  const lastFetchAt = new Map(); // key => ms

  const statusDot = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');
  const errorLine = document.getElementById('errorLine');
  const proxyToggleBtn = document.getElementById('proxyToggleBtn');

  const isIOS = /iP(hone|ad|od)/.test(navigator.userAgent);

  function setStatus(kind, text){
    statusText.textContent = text;
    statusDot.className = 'dot ' + (kind || '');
  }

  function showError(msg){
    errorLine.style.display = 'block';
    errorLine.textContent = msg;
  }
  function clearError(){
    errorLine.style.display = 'none';
    errorLine.textContent = '';
  }

  function updateProxyToggleLabel(){
    const label = proxyMode === 'auto' ? 'Proxy: Auto' : (proxyMode === 'on' ? 'Proxy: On' : 'Proxy: Off');
    proxyToggleBtn.textContent = label;
  }
  updateProxyToggleLabel();

  proxyToggleBtn.addEventListener('click', ()=>{
    proxyMode = (proxyMode === 'auto') ? 'on' : (proxyMode === 'on' ? 'off' : 'auto');
    localStorage.setItem(LS_PROXY_MODE, proxyMode);
    updateProxyToggleLabel();
    // Force a refresh
    loadInitialWindow(true);
  });

  /* ================= HELPERS ================= */
  const getEndpoint = (type, ts) =>
    `${baseUrl}&plugin-setting[schedule][mode]=${type}&plugin-setting[schedule][timestamp]=${ts}&limit=100`;

  const toTime = t => {
    if (!t) return "-";
    try {
      return new Date(t * 1000).toLocaleTimeString("en-IN", {
        timeZone: "Asia/Kolkata",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      });
    } catch {
      return "-";
    }
  };

  const fmtEstVsSch = (est, sch) => {
    const t = est || sch;
    return t ? toTime(t) : '-';
  };

  const airlineAllowed = fn => ["IX","AK","FD","J9","UL","FZ"].some(a => fn.startsWith(a));

  const getLogo = fn => {
    if (fn.startsWith("AK") || fn.startsWith("FD")) {
      return "https://upload.wikimedia.org/wikipedia/commons/thumb/8/82/AirAsia_New_Logo_%282020%29.svg/768px-AirAsia_New_Logo_%282020%29.svg.png";
    }
    let domain = "", format = "png";
    if (fn.startsWith("AI")) domain = "airindia.com";
    if (fn.startsWith("IX")) domain = "airindiaexpress.com";
    if (fn.startsWith("6E")) domain = "goindigo.in";
    if (fn.startsWith("UK")) domain = "airvistara.com";
    if (fn.startsWith("SG")) domain = "spicejet.com";
    if (fn.startsWith("QP")) domain = "akasaair.com";
    if (fn.startsWith("9I")) domain = "allianceair.in";
    if (fn.startsWith("I5")) domain = "airasia.co.in";
    if (fn.startsWith("EK")) domain = "emirates.com";
    if (fn.startsWith("EY")) domain = "etihad.com";
    if (fn.startsWith("QR")) domain = "qatarairways.com";
    if (fn.startsWith("SV")) domain = "saudia.com";
    if (fn.startsWith("KU")) domain = "kuwaitairways.com";
    if (fn.startsWith("WY")) domain = "omanair.com";
    if (fn.startsWith("GF")) domain = "gulfair.com";
    if (fn.startsWith("J9")) domain = "jazeeraairways.com";
    if (fn.startsWith("FZ")) { domain = "flydubai.com"; format = "svg"; }
    if (fn.startsWith("G9")) domain = "airarabia.com";
    if (fn.startsWith("NP")) domain = "flyadeal.com";
    if (fn.startsWith("XY")) domain = "flynas.com";
    if (fn.startsWith("UL")) domain = "srilankan.com";
    if (fn.startsWith("SQ")) domain = "singaporeair.com";
    if (fn.startsWith("TR")) domain = "scoot.co";
    if (fn.startsWith("MH")) domain = "malaysiaairlines.com";
    if (fn.startsWith("OD")) domain = "batikair.com";
    if (fn.startsWith("TG")) domain = "thaiairways.com";
    if (fn.startsWith("FD")) domain = "airasia.com";
    if (fn.startsWith("VN")) domain = "vietnamairlines.com";
    if (fn.startsWith("VJ")) domain = "vietjetair.com";
    if (fn.startsWith("BI")) domain = "rbair.com.bn";
    if (fn.startsWith("CX")) domain = "cathaypacific.com";
    if (fn.startsWith("JL")) domain = "jal.com";
    if (fn.startsWith("NH")) domain = "ana.co.jp";
    if (fn.startsWith("OZ")) domain = "flyasiana.com";
    if (fn.startsWith("KE")) domain = "koreanair.com";
    if (fn.startsWith("LH")) domain = "lufthansa.com";
    if (fn.startsWith("LX")) domain = "swiss.com";
    if (fn.startsWith("OS")) domain = "austrian.com";
    if (fn.startsWith("AF")) domain = "airfrance.com";
    if (fn.startsWith("KL")) domain = "klm.com";
    if (fn.startsWith("BA")) domain = "britishairways.com";
    if (fn.startsWith("VS")) domain = "virginatlantic.com";
    if (fn.startsWith("AY")) domain = "finnair.com";
    if (fn.startsWith("TK")) domain = "turkishairlines.com";
    if (fn.startsWith("AZ")) domain = "ita-airways.com";
    if (fn.startsWith("IB")) domain = "iberia.com";
    if (fn.startsWith("LO")) domain = "lot.com";
    if (fn.startsWith("SK")) domain = "flysas.com";
    if (fn.startsWith("UA")) domain = "united.com";
    if (fn.startsWith("AA")) domain = "aa.com";
    if (fn.startsWith("DL")) domain = "delta.com";
    if (fn.startsWith("AC")) domain = "aircanada.com";
    if (fn.startsWith("ET")) domain = "ethiopianairlines.com";
    if (fn.startsWith("KQ")) domain = "kenya-airways.com";
    if (fn.startsWith("MS")) domain = "egyptair.com";
    if (fn.startsWith("PK")) domain = "piac.com.pk";
    if (fn.startsWith("BG")) domain = "usbair.com";
    if (fn.startsWith("BS")) domain = "us-banglaairlines.com";
    if (fn.startsWith("5X")) domain = "ups.com";
    if (fn.startsWith("FX")) domain = "fedex.com";
    if (fn.startsWith("7L")) domain = "silkwaywest.com";
    if (fn.startsWith("CV")) domain = "cargolux.com";
    if (fn.startsWith("CK")) domain = "airchinacargo.com";
    if (fn.startsWith("CI")) domain = "china-airlines.com";
    if (!domain) return "";
    return `https://cdn.brandfetch.io/${domain}/logo.${format}?w=400&h=120&c=${BRANDFETCH_CLIENT_ID}`;
  };

  const delayMinutes = (sch, est) => (sch && est) ? Math.round((est - sch) / 60) : 0;

  const rowClass = (status, delay) => {
    if (status?.toLowerCase()?.includes("cancel")) return "cancelled";
    if (delay > 30) return "heavyDelay";
    if (delay > 5) return "delay";
    return "onTime";
  };

  const withinTimeWindow = (type, sch, est, act) => {
    const now = Math.floor(Date.now() / 1000);
    const oneHr = 3600;
    const twentyHr = now + 20 * oneHr;
    const t = sch || est || 0;
    const inWindow = t >= now - oneHr && t <= twentyHr;
    const delayed = sch && now > sch && (!act || act > now) && (est > now || !est);
    let completed = false;
    if (type === "arrivals") {
      completed = act && act >= now - 10800;
    } else {
      completed = act && act >= now - 300;
    }
    return inWindow || delayed || completed;
  };

  const cleanupFlights = (type, tbody) => {
    const now = Math.floor(Date.now() / 1000);
    Array.from(tbody.rows).forEach(row => {
      const act = parseInt(row.dataset.act) || 0;
      if (type === "arrivals") {
        if (act && act < now - 10800) row.remove();
      } else {
        if (act && act < now - 300) row.remove();
      }
    });
  };

  const sortTable = (tableId) => {
    const table = document.getElementById(tableId);
    const tbody = table.tBodies[0];
    const rows = Array.from(tbody.rows);
    rows.sort((a, b) => (parseInt(a.dataset.sch) || 0) - (parseInt(b.dataset.sch) || 0));
    rows.forEach(row => tbody.appendChild(row));
  };

  function canNotify(){
    return typeof Notification !== 'undefined' && 'permission' in Notification;
  }

  const notifyDelay = (fn, message) => {
    if (!canNotify()) return;
    if (Notification.permission === 'granted') {
      try { new Notification(`Flight ${fn}: ${message}`); } catch {}
    }
  };

  /* ================= FETCH WITH CORS FALLBACK ================= */
  function proxyUrlFor(url){
    // Public proxies are best-effort and may rate-limit.
    // For production, deploy your own proxy (e.g. Cloudflare Worker) for stable results.
    return [
      { name: 'corsproxy.io', url: `https://corsproxy.io/?${encodeURIComponent(url)}` },
      { name: 'allorigins', url: `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}` },
      { name: 'r.jina.ai', url: `https://r.jina.ai/${url}` },
    ];
  }

  async function fetchTextWithTimeout(url, timeoutMs=12000){
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeoutMs);
    try {
      const res = await fetch(url, {
        method: 'GET',
        cache: 'no-store',
        signal: ctrl.signal,
        // Do not set forbidden headers.
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.text();
    } finally {
      clearTimeout(t);
    }
  }

  function safeJsonParse(text){
    // Some proxies may wrap content; try to extract JSON object.
    const firstBrace = text.indexOf('{');
    const lastBrace = text.lastIndexOf('}');
    if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
      const slice = text.slice(firstBrace, lastBrace + 1);
      return JSON.parse(slice);
    }
    return JSON.parse(text);
  }

  async function fetchJsonSmart(url){
    // Decide whether to use proxy
    const shouldProxy = (proxyMode === 'on') || (proxyMode === 'auto' && isIOS);

    const attempts = [];
    if (!shouldProxy) attempts.push({ name: 'direct', url });
    attempts.push(...proxyUrlFor(url));
    if (shouldProxy) attempts.push({ name: 'direct', url }); // last resort if proxy fails

    let lastErr = null;
    for (const a of attempts) {
      try {
        setStatus('warn', `Loading (${a.name})â€¦`);
        const text = await fetchTextWithTimeout(a.url, 12000);
        const json = safeJsonParse(text);
        setStatus('ok', `Live (${a.name})`);
        clearError();
        return { json, route: a.name };
      } catch (e) {
        lastErr = e;
        // continue
      }
    }

    setStatus('bad', 'Blocked');
    const msg = (lastErr && lastErr.name === 'AbortError')
      ? 'Request timed out. Try Proxy: On or switch network.'
      : 'Could not load live data (likely CORS blocked on mobile/Safari). Try Proxy: On.';
    showError(msg);
    throw lastErr || new Error(msg);
  }

  function shouldFetchKey(key, minIntervalMs=20000){
    const last = lastFetchAt.get(key) || 0;
    const now = Date.now();
    if (now - last >= minIntervalMs) {
      lastFetchAt.set(key, now);
      return true;
    }
    return false;
  }

  /* ================= LOAD ================= */
  async function loadFlights(type, ts, append = true, force = false) {
    const key = `${type}:${ts}`;
    if (!force && !shouldFetchKey(key, 20000)) return;

    const url = getEndpoint(type, ts);
    const { json } = await fetchJsonSmart(url);

    const flights = json?.result?.response?.airport?.pluginData?.schedule?.[type]?.data || [];
    const tbody = document.querySelector(`#${type}-table tbody`);
    if (!append) tbody.innerHTML = "";

    flights.forEach(f => {
      const fl = f.flight;
      const fn = fl?.identification?.number?.default || "";
      if (!fn || !airlineAllowed(fn)) return;

      const isDep = type === "departures";
      const sch = isDep ? fl.time.scheduled?.departure : fl.time.scheduled?.arrival;
      const est = isDep ? fl.time.estimated?.departure : fl.time.estimated?.arrival;
      const act = isDep ? fl.time.actual?.departure : fl.time.actual?.arrival;
      if (!withinTimeWindow(type, sch, est, act)) return;

      const flightId = fl.identification?.id || fn;
      const existing = tbody.querySelector(`tr[data-flight-id="${CSS.escape(flightId)}"]`);

      const dly = delayMinutes(sch, est);
      const statusText = fl.status?.text || "-";
      const className = rowClass(statusText, dly);

      if (existing) {
        const oldClass = existing.className;
        const oldDelay = parseInt(existing.dataset.delay || '0') || 0;

        existing.cells[3].innerHTML = `${fmtEstVsSch(est, sch)} ${dly > 0 ? `(+${dly})` : ""}`;
        existing.cells[6].textContent = statusText;
        existing.className = className;
        existing.dataset.est = est || 0;
        existing.dataset.act = act || 0;
        existing.dataset.delay = dly || 0;

        if (dly > oldDelay && dly > 5) {
          notifyDelay(fn, `Delay increased by ${dly - oldDelay} minutes to ${dly} minutes total`);
        } else if (className === 'delay' && oldClass === 'onTime') {
          notifyDelay(fn, `Now delayed by ${dly} minutes`);
        } else if (className === 'heavyDelay' && (oldClass === 'onTime' || oldClass === 'delay')) {
          notifyDelay(fn, `Now heavily delayed by ${dly} minutes`);
        }
        return;
      }

      const tr = document.createElement("tr");
      tr.dataset.flightId = flightId;
      tr.dataset.sch = sch || 0;
      tr.dataset.est = est || 0;
      tr.dataset.act = act || 0;
      tr.dataset.delay = dly || 0;
      tr.className = className;

      const reg = fl.aircraft?.registration || "-";
      const fromTo = isDep ? (fl.airport.destination?.code?.iata || "-") : (fl.airport.origin?.code?.iata || "-");
      const logo = getLogo(fn);
      const model = fl.aircraft?.model?.text || "-";

      tr.innerHTML = `
        <td>${logo ? `<img class="flight-logo" src="${logo}" alt="${fn} logo" loading="lazy">` : ''}${fn}</td>
        <td>${reg}</td>
        <td>${fromTo}</td>
        <td>${fmtEstVsSch(est, sch)} ${dly > 0 ? `(+${dly})` : ""}</td>
        <td>${toTime(sch)}</td>
        <td>${model}</td>
        <td>${statusText}</td>`;

      tbody.appendChild(tr);
    });

    cleanupFlights(type, tbody);
    sortTable(`${type}-table`);
  }

  /* ================= BUILD TURNAROUNDS ================= */
  function buildTurnarounds() {
    const arrivalsRows = Array.from(document.querySelector('#arrivals-table tbody').rows);
    const departuresRows = Array.from(document.querySelector('#departures-table tbody').rows);
    const regToArr = new Map();
    const regToDep = new Map();

    arrivalsRows.forEach(row => {
      const reg = row.cells[1].textContent.trim();
      if (reg === '-' || !reg) return;
      const arr = {
        fn: row.cells[0].textContent.trim(),
        reg,
        from: row.cells[2].textContent.trim(),
        eta: parseInt(row.dataset.est) || parseInt(row.dataset.sch) || 0,
        sch: parseInt(row.dataset.sch) || 0,
        act: parseInt(row.dataset.act) || 0,
        aircraft: row.cells[5].textContent.trim(),
        status: row.cells[6].textContent.trim()
      };
      if (!regToArr.has(reg)) regToArr.set(reg, []);
      regToArr.get(reg).push(arr);
    });

    departuresRows.forEach(row => {
      const reg = row.cells[1].textContent.trim();
      if (reg === '-' || !reg) return;
      const dep = {
        fn: row.cells[0].textContent.trim(),
        reg,
        to: row.cells[2].textContent.trim(),
        etd: parseInt(row.dataset.est) || parseInt(row.dataset.sch) || 0,
        sch: parseInt(row.dataset.sch) || 0,
        act: parseInt(row.dataset.act) || 0,
        aircraft: row.cells[5].textContent.trim(),
        status: row.cells[6].textContent.trim()
      };
      if (!regToDep.has(reg)) regToDep.set(reg, []);
      regToDep.get(reg).push(dep);
    });

    const tbody = document.querySelector('#turnarounds-table tbody');
    tbody.innerHTML = '';

    for (const reg of regToArr.keys()) {
      if (!regToDep.has(reg)) continue;
      const arrs = regToArr.get(reg).sort((a, b) => a.eta - b.eta);
      const deps = regToDep.get(reg).sort((a, b) => a.etd - b.etd);

      for (const arr of arrs) {
        for (const dep of deps) {
          if (dep.etd > arr.eta && dep.etd - arr.eta <= 2.5 * 3600) {
            const arrDly = delayMinutes(arr.sch, arr.eta);
            const depDly = delayMinutes(dep.sch, dep.etd);
            const maxDly = Math.max(arrDly, depDly);
            const statusText = `${arr.status} / ${dep.status}`;
            const className = rowClass(statusText, maxDly);

            const arrEtaStr = `${toTime(arr.eta)} ${arrDly > 0 ? `(+${arrDly})` : ''}`;
            const depEtdStr = `${toTime(dep.etd)} ${depDly > 0 ? `(+${depDly})` : ''}`;

            const logoSrc = getLogo(arr.fn);
            const tr = document.createElement('tr');
            tr.dataset.sch = arr.sch || 0;
            tr.className = className;
            tr.innerHTML = `
              <td>${logoSrc ? `<img class="flight-logo" src="${logoSrc}" alt="${arr.fn} logo" loading="lazy">` : ''}${arr.fn} / ${dep.fn}</td>
              <td>${reg}</td>
              <td>${arr.from}</td>
              <td>${dep.to}</td>
              <td>${arrEtaStr} / ${depEtdStr}</td>
              <td>${toTime(arr.sch)} / ${toTime(dep.sch)}</td>
              <td>${arr.aircraft}</td>
              <td>${statusText}</td>
            `;
            tbody.appendChild(tr);
          }
        }
      }
    }
    sortTable('turnarounds-table');
  }

  /* ================= AUTO LOADER ================= */
  let loading = false;
  async function loadInitialWindow(force = false) {
    if (loading) return;
    loading = true;

    try {
      baseTimestamp = Math.floor(Date.now() / 1000);
      const timestamps = [];
      for (let i = -1; i <= 4; i++) timestamps.push(baseTimestamp + i * 6 * 3600);

      // Load in small batches to be nicer on mobile networks.
      for (const ts of timestamps) {
        await Promise.all([
          loadFlights("arrivals", ts, true, force),
          loadFlights("departures", ts, true, force)
        ]);
      }

      buildTurnarounds();
      if (document.querySelector('#arrivals-table tbody').rows.length === 0 && document.querySelector('#departures-table tbody').rows.length === 0) {
        showError('No flights matched filters in the current time window.');
        setStatus('warn', statusText.textContent);
      }
    } catch (e) {
      // Error already surfaced in UI
    } finally {
      loading = false;
    }
  }

  /* ================= CONTROLS ================= */
  document.getElementById("loadEarlierBtn").onclick = async () => {
    baseTimestamp -= 6 * 3600;
    try {
      await Promise.all([
        loadFlights("arrivals", baseTimestamp, true, true),
        loadFlights("departures", baseTimestamp, true, true)
      ]);
      buildTurnarounds();
    } catch {}
  };

  document.getElementById("notifyBtn").onclick = async () => {
    if (!canNotify()) {
      alert('Notifications are not supported in this browser (iOS Safari usually needs "Add to Home Screen" / PWA).');
      return;
    }
    if (Notification.permission === 'default') {
      try {
        const permission = await Notification.requestPermission();
        alert(permission === 'granted' ? 'Notifications enabled' : 'Notifications denied');
      } catch {
        alert('Notification permission request failed on this device.');
      }
    } else if (Notification.permission === 'granted') {
      alert('Notifications already enabled');
    } else {
      alert('Notifications denied. Please change in browser settings.');
    }
  };

  document.getElementById("themeToggle").onclick = () => {
    document.documentElement.dataset.theme = document.documentElement.dataset.theme === "dark" ? "light" : "dark";
  };

  /* ================= TAB SWITCH ================= */
  function activateTab(tab){
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    tab.classList.add('active');
  }
  document.getElementById('flightsTab').onclick=()=>{
    document.getElementById('flights-section').classList.add('active');
    document.getElementById('turnarounds-section').classList.remove('active');
    activateTab(document.getElementById('flightsTab'));
  };
  document.getElementById('turnTab').onclick=()=>{
    document.getElementById('turnarounds-section').classList.add('active');
    document.getElementById('flights-section').classList.remove('active');
    activateTab(document.getElementById('turnTab'));
  };

  /* ================= START ================= */
  // Default: auto proxy on iOS
  if (proxyMode === 'auto' && isIOS) {
    showError('Detected iOS: using Proxy in Auto mode to bypass CORS restrictions.');
    setStatus('warn', 'iOS (proxy auto)');
  } else {
    setStatus('', 'Idle');
  }

  loadInitialWindow(true);
  setInterval(() => loadInitialWindow(false), 30000);

  window.addEventListener('online', ()=> loadInitialWindow(true));
</script>

</body>
</html>
