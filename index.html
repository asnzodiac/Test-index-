<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>AIX Security â€“ COK</title>
<meta name="theme-color" content="#000000"/>
<meta name="description" content="AIX Security Flight Dashboard â€“ Cochin International Airport (COK)"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
<meta name="apple-mobile-web-app-title" content="AIX COK"/>
<link rel="manifest" id="manifestLink" href="manifest.json"/>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSS VARIABLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:#f4f6f9;
  --bg2:#fff;
  --text:#111;
  --text2:#555;
  --hdr:#2c3e50;
  --th:#2c3e50;
  --tht:#fff;
  --green:#c8f7c5;
  --green-t:#1e8449;
  --yellow:#fff3b0;
  --yellow-t:#b7770d;
  --red:#f7c5c5;
  --red-t:#c0392b;
  --grey:#e0e0e0;
  --grey-t:#555;
  --border:#e0e4ea;
  --btn:#2c3e50;
  --btntxt:#fff;
  --shadow:rgba(0,0,0,0.10);
  --accent:#1a73e8;
  --accent2:#e74c3c;
  --tag-bg:rgba(0,0,0,0.06);
  --card-radius:10px;
  --hdr-h:56px;
}
[data-theme="dark"] {
  --bg:#0f1117;
  --bg2:#1a1d27;
  --text:#e8eaf0;
  --text2:#9aa0b0;
  --hdr:#161b27;
  --th:#1e2433;
  --tht:#e8eaf0;
  --green:#1f4d2b;
  --green-t:#6fcf97;
  --yellow:#5c4b00;
  --yellow-t:#f6c90e;
  --red:#5c1f1f;
  --red-t:#ff6b6b;
  --grey:#2a2d3a;
  --grey-t:#9aa0b0;
  --border:#2a2e3d;
  --btn:#2a3148;
  --btntxt:#e8eaf0;
  --shadow:rgba(0,0,0,0.45);
  --accent:#4da3ff;
  --accent2:#ff6b6b;
  --tag-bg:rgba(255,255,255,0.07);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET & BASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{
  background:var(--bg);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  font-size:13px;
  line-height:1.45;
  min-height:100vh;
  overflow-x:hidden;
  transition:background .25s,color .25s;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header{
  background:var(--hdr);
  color:#fff;
  height:var(--hdr-h);
  padding:0 14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  box-shadow:0 2px 12px var(--shadow);
  position:sticky;
  top:0;
  z-index:300;
}
.h-left{display:flex;align-items:center;gap:9px;min-width:0;}
.h-logo{font-size:22px;flex-shrink:0;}
.h-titles{display:flex;flex-direction:column;min-width:0;}
.h-main{font-size:15px;font-weight:800;white-space:nowrap;color:#fff;display:flex;align-items:center;gap:6px;}
.airport-badge{
  background:#e74c3c;color:#fff;
  border-radius:4px;padding:2px 7px;
  font-size:13px;font-weight:900;letter-spacing:1px;
}
.h-sub{font-size:9.5px;opacity:.65;letter-spacing:.9px;text-transform:uppercase;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.h-right{display:flex;align-items:center;gap:5px;flex-shrink:0;}

/* icon-only buttons in header */
.icon-btn{
  background:rgba(255,255,255,0.13);
  border:1px solid rgba(255,255,255,0.18);
  color:#fff;
  width:36px;height:36px;
  border-radius:8px;
  cursor:pointer;
  font-size:16px;
  display:flex;align-items:center;justify-content:center;
  transition:background .15s,transform .12s;
  flex-shrink:0;
}
.icon-btn:hover{background:rgba(255,255,255,0.22);transform:scale(1.08);}
.icon-btn:active{transform:scale(0.96);}
.icon-btn.notify-on{background:rgba(39,174,96,.45);border-color:rgba(39,174,96,.6);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATUS BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.status-bar{
  background:var(--bg2);
  border-bottom:1px solid var(--border);
  padding:5px 14px;
  display:flex;align-items:center;gap:10px;
  font-size:10.5px;color:var(--text2);
  flex-wrap:wrap;
}
.live-pill{
  display:inline-flex;align-items:center;gap:5px;
  background:rgba(39,174,96,.12);
  border:1px solid rgba(39,174,96,.3);
  border-radius:20px;padding:2px 9px;
  font-weight:700;font-size:10px;color:#1e8449;
}
[data-theme="dark"] .live-pill{color:#6fcf97;background:rgba(39,174,96,.15);}
.dot{
  width:7px;height:7px;border-radius:50%;
  background:#27ae60;
  box-shadow:0 0 0 2px rgba(39,174,96,.3);
  animation:pulse 2s infinite;
}
.dot.loading{background:#f39c12;box-shadow:0 0 0 2px rgba(243,156,18,.3);}
.dot.error{background:#e74c3c;box-shadow:0 0 0 2px rgba(231,76,60,.3);animation:none;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.55;transform:scale(.82);}}
#refreshCountdown{margin-left:auto;font-size:9.5px;opacity:.55;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEGEND (collapsible on mobile)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.legend{
  display:flex;align-items:center;gap:10px;
  padding:5px 14px;
  background:var(--bg2);
  border-bottom:1px solid var(--border);
  flex-wrap:wrap;font-size:10.5px;
}
.legend strong{margin-right:2px;font-size:10.5px;}
.legend-item{display:inline-flex;align-items:center;gap:4px;}
.lsw{width:11px;height:11px;border-radius:2px;border:1px solid rgba(0,0,0,0.1);flex-shrink:0;}
[data-theme="dark"] .lsw{border-color:rgba(255,255,255,0.12);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACTION BAR (Load Earlier + big btn)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.action-bar{
  display:flex;align-items:center;gap:7px;
  padding:8px 14px;
  background:var(--bg2);
  border-bottom:2px solid var(--border);
  flex-wrap:wrap;
}
.btn{
  background:var(--btn);color:var(--btntxt);
  border:none;padding:7px 13px;
  border-radius:7px;cursor:pointer;
  font-size:11.5px;font-weight:700;
  white-space:nowrap;display:inline-flex;
  align-items:center;gap:5px;
  transition:opacity .15s,transform .12s,box-shadow .15s;
  letter-spacing:.2px;
}
.btn:hover{opacity:.82;transform:translateY(-1px);box-shadow:0 3px 8px var(--shadow);}
.btn:active{transform:translateY(0);opacity:1;}
.btn-earlier{background:#34495e;}
.btn-primary{background:var(--accent);}
[data-theme="dark"] .btn-earlier{background:#2a3a50;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tabs{
  display:flex;
  background:var(--hdr);
  padding:0 8px;
  gap:4px;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
  border-bottom:3px solid var(--border);
}
.tabs::-webkit-scrollbar{display:none;}
.tab-btn{
  background:transparent;
  color:rgba(255,255,255,.6);
  border:none;
  border-bottom:3px solid transparent;
  margin-bottom:-3px;
  padding:11px 16px;
  cursor:pointer;
  font-size:12.5px;font-weight:700;
  white-space:nowrap;
  transition:color .15s,border-color .15s;
  letter-spacing:.2px;
}
.tab-btn:hover{color:rgba(255,255,255,.9);}
.tab-btn.active{
  color:#fff;
  border-bottom-color:#fff;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTENT SECTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tab-content{display:none;}
.tab-content.active{display:block;}

.section-hdr{
  display:flex;align-items:center;gap:8px;
  padding:8px 14px;
  background:var(--bg2);
  border-bottom:1px solid var(--border);
  font-size:13px;font-weight:800;letter-spacing:.2px;
  position:sticky;
  top:var(--hdr-h);
  z-index:100;
}
.section-sep{border-top:4px solid var(--border);}
.count-badge{
  background:var(--accent);color:#fff;
  border-radius:10px;padding:1px 8px;
  font-size:10.5px;font-weight:800;min-width:22px;text-align:center;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABLE WRAPPER â€” DESKTOP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{
  width:100%;border-collapse:collapse;
  font-size:12.5px;min-width:560px;
}
thead th{
  background:var(--th);color:var(--tht);
  padding:8px 10px;text-align:left;
  font-weight:700;font-size:10px;
  text-transform:uppercase;letter-spacing:.7px;
  white-space:nowrap;user-select:none;
  border-bottom:2px solid rgba(255,255,255,.1);
}
tbody tr{border-bottom:1px solid var(--border);transition:filter .12s;}
tbody tr:hover{filter:brightness(.95);}
[data-theme="dark"] tbody tr:hover{filter:brightness(1.1);}
tbody td{padding:7px 10px;vertical-align:middle;white-space:nowrap;}

/* row bg */
.onTime{background:var(--green);}
.delay{background:var(--yellow);}
.heavyDelay{background:var(--red);}
.cancelled{background:var(--grey);}

/* cell helpers */
.logo-cell{width:72px;padding:4px 7px !important;}
.logo-cell img{height:22px;max-width:68px;object-fit:contain;display:block;}
.logo-ph{
  width:52px;height:20px;background:var(--tag-bg);
  border-radius:3px;display:flex;align-items:center;
  justify-content:center;font-size:8.5px;font-weight:700;
  color:var(--text);opacity:.55;letter-spacing:.4px;
}
.fnum{font-weight:800;font-size:12.5px;letter-spacing:.7px;}
.reg{font-family:'Courier New',monospace;color:var(--accent);font-size:11.5px;font-weight:700;}
.route{font-size:11.5px;max-width:130px;overflow:hidden;text-overflow:ellipsis;}
.tcell{font-family:'Courier New',monospace;font-size:12.5px;font-weight:700;}
.test{display:block;}
.tdelay{display:block;font-size:9.5px;color:var(--red-t);font-weight:800;margin-top:1px;}
.tsch{font-family:'Courier New',monospace;font-size:11.5px;opacity:.6;}
.actype{font-size:11px;font-weight:600;}
.sbadge{
  display:inline-block;padding:2px 7px;
  border-radius:9px;font-size:9.5px;font-weight:800;
  text-transform:uppercase;letter-spacing:.4px;
  background:var(--tag-bg);white-space:nowrap;
  border:1px solid rgba(0,0,0,.06);
}
[data-theme="dark"] .sbadge{border-color:rgba(255,255,255,.06);}
.sbadge.landed,.sbadge.arrived{background:rgba(39,174,96,.18);color:var(--green-t);}
.sbadge.airborne{background:rgba(26,115,232,.15);color:var(--accent);}
.sbadge.delayed{background:rgba(230,126,34,.18);color:var(--yellow-t);}
.sbadge.cancelled{background:rgba(231,76,60,.18);color:var(--red-t);}

.empty-row td{
  text-align:center;padding:28px 14px;
  color:var(--text2);font-style:italic;font-size:12px;
}
.spinner{
  display:inline-block;width:16px;height:16px;
  border:2px solid var(--border);border-top-color:var(--accent);
  border-radius:50%;animation:spin .75s linear infinite;
  vertical-align:middle;margin-right:6px;
}
@keyframes spin{to{transform:rotate(360deg);}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE CARD VIEW  (â‰¤ 640px)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:640px){
  .table-wrap{overflow-x:unset;}
  table{display:block;min-width:unset;}
  thead{display:none;}
  tbody{display:flex;flex-direction:column;gap:8px;padding:8px;}
  tbody tr{
    display:grid;
    grid-template-columns:56px 1fr auto;
    grid-template-rows:auto auto;
    column-gap:8px;row-gap:3px;
    border-radius:var(--card-radius);
    border:1px solid var(--border);
    padding:9px 10px;
    box-shadow:0 1px 4px var(--shadow);
    border-bottom:1px solid var(--border) !important;
  }
  /* logo col */
  tbody td.logo-cell{
    grid-column:1;grid-row:1/3;
    width:auto;padding:0 !important;
    display:flex;align-items:center;justify-content:center;
  }
  tbody td.logo-cell img{height:28px;max-width:54px;}
  /* flight num + route = col2 row1 */
  tbody td.fnum{grid-column:2;grid-row:1;font-size:13px;}
  tbody td.route{grid-column:2;grid-row:2;white-space:normal;max-width:unset;color:var(--text2);}
  /* time col = col3 row1 */
  tbody td.tcell{grid-column:3;grid-row:1;text-align:right;}
  /* reg / ac / status â€” hidden or inline */
  tbody td.reg{grid-column:2;grid-row:2;display:none;}/* hide reg on mobile */
  tbody td.actype{display:none;}
  tbody td.tsch{grid-column:3;grid-row:2;text-align:right;}
  tbody td:last-child{grid-column:1/-1;grid-row:3;padding-top:4px;}
  /* extra info row */
  .card-info{
    display:flex;align-items:center;gap:8px;
    padding-top:4px;border-top:1px solid var(--border);margin-top:2px;
    font-size:10px;color:var(--text2);
    grid-column:1/-1;
  }
  .card-reg{font-family:'Courier New',monospace;color:var(--accent);font-weight:700;font-size:10.5px;}

  /* turnaround table on mobile */
  #taBody tr{
    grid-template-columns:56px 1fr auto;
    grid-template-rows:auto auto auto;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TURNAROUND
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ta-fns{display:flex;flex-direction:column;gap:1px;}
.ta-fn{font-weight:800;font-size:12.5px;}
.ta-fn2{font-size:10.5px;opacity:.7;}
.ta-times{font-family:'Courier New',monospace;font-size:12px;font-weight:700;line-height:1.7;}
.ta-sep{font-size:9px;opacity:.4;display:block;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INSTALL + TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#install-btn{
  position:fixed;bottom:20px;right:16px;
  background:var(--accent);color:#fff;
  border:none;padding:11px 18px;
  border-radius:50px;cursor:pointer;
  font-size:12.5px;font-weight:800;
  box-shadow:0 4px 18px rgba(26,115,232,.45);
  display:none;z-index:9999;
  align-items:center;gap:6px;
  animation:slideUp .35s cubic-bezier(.34,1.56,.64,1);
}
@keyframes slideUp{from{transform:translateY(30px);opacity:0;}to{transform:translateY(0);opacity:1;}}
#toast{
  position:fixed;bottom:78px;left:50%;transform:translateX(-50%) translateY(12px);
  background:rgba(20,20,30,.92);color:#fff;
  padding:9px 16px;border-radius:8px;
  font-size:12px;font-weight:600;
  z-index:9998;opacity:0;
  transition:opacity .25s,transform .25s;
  max-width:calc(100vw - 28px);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  pointer-events:none;backdrop-filter:blur(6px);
  box-shadow:0 4px 20px rgba(0,0,0,.3);
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
[data-theme="dark"] #toast{background:rgba(240,240,240,.93);color:#111;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MISC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:360px){
  .h-sub{display:none;}
  .h-main{font-size:13.5px;}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â• -->
<header>
  <div class="h-left">
    <div class="h-logo">âœˆï¸</div>
    <div class="h-titles">
      <span class="h-main">AIX Security <span class="airport-badge">COK</span></span>
      <span class="h-sub">Cochin Intl Airport Â· Live Dashboard</span>
    </div>
  </div>
  <div class="h-right">
    <button class="icon-btn" id="notifyBtn" onclick="enableNotifications()" title="Enable Notifications">ğŸ””</button>
    <button class="icon-btn" id="darkBtn"   onclick="toggleDark()"          title="Toggle Dark Mode">ğŸŒ™</button>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• STATUS BAR â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="status-bar">
  <span class="live-pill"><span class="dot" id="liveDot"></span>LIVE</span>
  <span id="lastUpdate">Initializingâ€¦</span>
  <span id="flightSummary"></span>
  <span id="refreshCountdown"></span>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• LEGEND â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="legend">
  <strong>Legend:</strong>
  <span class="legend-item"><span class="lsw" style="background:var(--green)"></span>On Time</span>
  <span class="legend-item"><span class="lsw" style="background:var(--yellow)"></span>Delay &lt;45m</span>
  <span class="legend-item"><span class="lsw" style="background:var(--red)"></span>Heavy â‰¥45m</span>
  <span class="legend-item"><span class="lsw" style="background:var(--grey)"></span>Cancelled</span>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• ACTION BAR â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="action-bar">
  <button class="btn btn-earlier" onclick="loadEarlier()">â® Earlier Flights</button>
  <button class="btn btn-primary" onclick="refresh(true)">ğŸ”„ Refresh Now</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• TABS â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tabs">
  <button class="tab-btn active" id="tab-flights"    onclick="switchTab('flights')">ğŸ›¬ COK FLIGHTS ğŸ›«</button>
  <button class="tab-btn"        id="tab-turnaround" onclick="switchTab('turnaround')">ğŸ”„ Turnaround</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• FLIGHTS TAB â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-content active" id="content-flights">

  <!-- ARRIVALS -->
  <div class="section-hdr">
    ğŸ›¬ Arrivals <span class="count-badge" id="arrCount">0</span>
  </div>
  <div class="table-wrap">
    <table id="arrTable">
      <thead>
        <tr>
          <th style="width:74px">Airline</th>
          <th>Flight</th>
          <th>Reg</th>
          <th>From</th>
          <th>ETA</th>
          <th>STA</th>
          <th>A/C</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="arrBody">
        <tr class="empty-row"><td colspan="8"><span class="spinner"></span>Loading arrivalsâ€¦</td></tr>
      </tbody>
    </table>
  </div>

  <!-- DEPARTURES -->
  <div class="section-hdr section-sep">
    ğŸ›« Departures <span class="count-badge" id="depCount">0</span>
  </div>
  <div class="table-wrap">
    <table id="depTable">
      <thead>
        <tr>
          <th style="width:74px">Airline</th>
          <th>Flight</th>
          <th>Reg</th>
          <th>To</th>
          <th>ETD</th>
          <th>STD</th>
          <th>A/C</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="depBody">
        <tr class="empty-row"><td colspan="8"><span class="spinner"></span>Loading departuresâ€¦</td></tr>
      </tbody>
    </table>
  </div>

</div><!-- /content-flights -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â• TURNAROUND TAB â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-content" id="content-turnaround">
  <div class="section-hdr">
    ğŸ”„ Turnaround Flights <span class="count-badge" id="taCount">0</span>
  </div>
  <div class="table-wrap">
    <table id="taTable">
      <thead>
        <tr>
          <th style="width:74px">Airline</th>
          <th>Flights</th>
          <th>Reg</th>
          <th>From</th>
          <th>To</th>
          <th>ETA/ETD</th>
          <th>STA/STD</th>
          <th>A/C</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="taBody">
        <tr class="empty-row"><td colspan="9">Turnaround data loads with flights.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- INSTALL BTN -->
<button id="install-btn" onclick="installApp()">ğŸ“² Install App</button>
<!-- TOAST -->
<div id="toast"></div>

<script>
'use strict';
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MANIFEST BLOB
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(function(){
  const m={name:'AIX Security â€“ COK',short_name:'AIX COK',
    description:'Real-time flight dashboard for Cochin International Airport',
    start_url:'./',display:'standalone',background_color:'#000',theme_color:'#000',
    orientation:'any',
    icons:[{src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%231a73e8'/%3E%3Ctext y='.9em' font-size='72' text-anchor='middle' x='50'%3E%E2%9C%88%EF%B8%8F%3C/text%3E%3C/svg%3E",sizes:'512x512',type:'image/svg+xml',purpose:'any maskable'}]};
  try{
    const u=URL.createObjectURL(new Blob([JSON.stringify(m)],{type:'application/json'}));
    const l=document.getElementById('manifestLink');if(l)l.href=u;
  }catch(e){}
})();

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SERVICE WORKER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./service-worker.js',{scope:'./'})
    .catch(()=>{
      const sw=`const C='aix-v2';
self.addEventListener('install',e=>{e.waitUntil(caches.open(C).then(c=>c.addAll(['/'])));self.skipWaiting();});
self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==C).map(k=>caches.delete(k)))));self.clients.claim();});
self.addEventListener('fetch',e=>{if(/flightradar24|allorigins|corsproxy/.test(e.request.url))return;e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).catch(()=>caches.match('/'))));});`;
      try{navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:'application/javascript'})),{scope:'./'}).catch(()=>{});}catch(e){}
    });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   INSTALL PROMPT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;document.getElementById('install-btn').style.display='inline-flex';});
window.addEventListener('appinstalled',()=>{document.getElementById('install-btn').style.display='none';deferredPrompt=null;});
function installApp(){if(!deferredPrompt)return;deferredPrompt.prompt();deferredPrompt.userChoice.then(r=>{deferredPrompt=null;document.getElementById('install-btn').style.display='none';if(r.outcome==='accepted')showToast('âœ… App installed!');});}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CONFIG
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const AIRPORT    = 'cok';
const ALLOWED    = ['IX','AK','FD','J9','UL','FZ'];
const BASE_API   = 'https://api.flightradar24.com/common/v1/airport.json';
const PROXY1     = 'https://api.allorigins.win/get?url=';
const PROXY2     = 'https://corsproxy.io/?';
const REFRESH_MS = 30000;

const DOMAIN_MAP = {
  'AI':'airindia.com','IX':'airindiaexpress.com','6E':'goindigo.in',
  'UK':'airvistara.com','SG':'spicejet.com','QP':'akasaair.com',
  '9I':'allianceair.in','I5':'airasia.co.in','EK':'emirates.com',
  'EY':'etihad.com','QR':'qatarairways.com','SV':'saudia.com',
  'KU':'kuwaitairways.com','WY':'omanair.com','GF':'gulfair.com',
  'J9':'jazeeraairways.com','FZ':'flydubai.com','G9':'airarabia.com',
  'NP':'flyadeal.com','XY':'flynas.com','UL':'srilankan.com',
  'SQ':'singaporeair.com','TR':'scoot.co','MH':'malaysiaairlines.com',
  'OD':'batikair.com','TG':'thaiairways.com','FD':'airasia.com',
  'AK':'airasia.com','VN':'vietnamairlines.com','VJ':'vietjetair.com',
  'BI':'royalbrunei.com','CX':'cathaypacific.com','JL':'jal.com',
  'NH':'ana.co.jp','OZ':'flyasiana.com','KE':'koreanair.com',
  'LH':'lufthansa.com','LX':'swiss.com','OS':'austrian.com',
  'AF':'airfrance.com','KL':'klm.com','BA':'britishairways.com',
  'VS':'virginatlantic.com','AY':'finnair.com','TK':'turkishairlines.com',
  'AZ':'alitalia.com','IB':'iberia.com','LO':'lot.com','SK':'flysas.com',
  'UA':'united.com','AA':'aa.com','DL':'delta.com','AC':'aircanada.com',
  'ET':'ethiopianairlines.com','KQ':'kenya-airways.com','MS':'egyptair.com',
  'PK':'piac.com.pk','BG':'biman-airlines.com','BS':'bassaka-air.com',
  '5X':'ups.com','FX':'fedex.com','7L':'aeroflot.ru','CV':'cargolux.com',
  'CK':'chinacargo.com','CI':'china-airlines.com',
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   LOGO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function getPrefix(fn){
  if(!fn)return'';
  const m=fn.match(/^([A-Z0-9]{2})/i);
  return m?m[1].toUpperCase():'';
}
function getLogo(fn){
  const c=getPrefix(fn);if(!c)return'';
  if(c==='AK'||c==='FD')return'https://upload.wikimedia.org/wikipedia/commons/thumb/8/82/AirAsia_New_Logo_%282020%29.svg/768px-AirAsia_New_Logo_%282020%29.svg.png';
  const d=DOMAIN_MAP[c];if(!d)return'';
  const fmt=c==='FZ'?'svg':'png';
  return`https://cdn.brandfetch.io/${d}/logo.${fmt}?w=400&h=120&c=1idBLQ1djCDndBUmUVs`;
}
function logoHtml(fn){
  const url=getLogo(fn),p=getPrefix(fn);
  if(!url)return`<span class="logo-ph">${p}</span>`;
  return`<img src="${url}" alt="${p}" loading="lazy" onerror="this.style.display='none';this.insertAdjacentHTML('afterend','<span class=\\'logo-ph\\'>${p}</span>')">`;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TIME UTILS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toTime(t){
  if(t==null||t===''||t===0)return'â€“';
  return new Date(Number(t)*1000).toLocaleTimeString('en-IN',{
    hour:'2-digit',minute:'2-digit',hour12:false,timeZone:'Asia/Kolkata'
  }).replace('24:','00:');
}
function delayMin(sch,est){
  if(!sch||!est)return 0;
  const d=Math.round((Number(est)-Number(sch))/60);
  return d>0?d:0;
}
function rowCls(status,delay){
  const s=(status||'').toLowerCase();
  if(s.includes('cancel'))return'cancelled';
  if(delay>=45)return'heavyDelay';
  if(delay>0)return'delay';
  return'onTime';
}
function sbCls(status){
  const s=(status||'').toLowerCase();
  if(s.includes('land')||s.includes('arriv'))return'landed';
  if(s.includes('airborne')||s.includes('en route')||s.includes('enroute'))return'airborne';
  if(s.includes('depart'))return'airborne';
  if(s.includes('cancel'))return'cancelled';
  if(s.includes('delay'))return'delayed';
  return'';
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TIME WINDOW â€” generous: 12h back, 24h fwd
   Previous flights are kept (no auto-remove
   during a manual "load earlier" cycle)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function withinWindow(sch,est,act){
  const now=Date.now()/1000;
  const ref=act||est||sch;
  const schT=sch||ref;
  if(!schT)return false;
  if(schT<now-43200)return false;   // older than 12 h â†’ skip (unless from earlier load)
  if(schT>now+86400)return false;   // more than 24 h ahead â†’ skip
  return true;
}
// Wider window for "load earlier" calls â€” go back up to 48h
function withinWindowWide(sch,est,act){
  const now=Date.now()/1000;
  const ref=act||est||sch;
  const schT=sch||ref;
  if(!schT)return false;
  if(schT<now-172800)return false;  // 48h back
  if(schT>now+86400)return false;
  return true;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   STATE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const arrState=new Map(),depState=new Map();
let baseTs=Math.floor(Date.now()/1000);
let earliestTs=baseTs-21600;
let refreshTimer=null,cdTimer=null,nextCd=REFRESH_MS/1000;
let isBusy=false;
let loadEarlierMode=false; // when true, use wide window

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   FETCH (3-layer proxy)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function fetchData(url){
  // Direct
  try{
    const r=await fetch(url,{headers:{'Accept':'application/json'},mode:'cors',cache:'no-cache'});
    if(r.ok){const j=await r.json();if(j?.result)return j;}
  }catch(e){}
  // allorigins
  try{
    const r=await fetch(PROXY1+encodeURIComponent(url),{cache:'no-cache'});
    if(r.ok){const j=await r.json();if(j.contents){const d=JSON.parse(j.contents);if(d?.result)return d;}}
  }catch(e){}
  // corsproxy
  try{
    const r=await fetch(PROXY2+encodeURIComponent(url),{cache:'no-cache'});
    if(r.ok){const j=await r.json();if(j?.result)return j;}
  }catch(e){}
  return null;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   BUILD ROW CELLS  (returns innerHTML string)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildRow(fl,type){
  const fn=fl.identification?.number?.default||fl.identification?.callsign||'';
  const reg=fl.aircraft?.registration||'â€“';
  const ac=fl.aircraft?.model?.text||fl.aircraft?.model?.code||'â€“';
  const status=fl.status?.text||'Scheduled';
  let sch,est,act;
  if(type==='arrivals'){sch=fl.time?.scheduled?.arrival;est=fl.time?.estimated?.arrival;act=fl.time?.real?.arrival;}
  else{sch=fl.time?.scheduled?.departure;est=fl.time?.estimated?.departure;act=fl.time?.real?.departure;}
  const disp=act||est||sch;
  const delay=delayMin(sch,disp);
  const ap=fl.airport;
  let origin='',dest='';
  if(ap){
    const o=ap.origin,d=ap.destination;
    origin=(o?.name||o?.code?.iata||'').replace(/ (International|Int'l|Intl|Airport)\.?/gi,'').trim();
    dest  =(d?.name||d?.code?.iata||'').replace(/ (International|Int'l|Intl|Airport)\.?/gi,'').trim();
    if(origin.length>18&&o?.code?.iata)origin=o.code.iata;
    if(dest.length>18&&d?.code?.iata)dest=d.code.iata;
  }
  const delStr=delay>0?`<span class="tdelay">+${delay}m late</span>`:'';
  const sc=sbCls(status);
  const lh=logoHtml(fn);
  if(type==='arrivals'){
    return{cells:`
<td class="logo-cell">${lh}</td>
<td class="fnum">${fn}</td>
<td class="reg">${reg}</td>
<td class="route" title="${origin}">${origin||'â€“'}</td>
<td class="tcell"><span class="test">${toTime(disp)}</span>${delStr}</td>
<td class="tsch">${toTime(sch)}</td>
<td class="actype">${ac}</td>
<td><span class="sbadge ${sc}">${status}</span></td>`,fn,reg,sch,disp,delay,status,origin,dest,ac};
  }else{
    return{cells:`
<td class="logo-cell">${lh}</td>
<td class="fnum">${fn}</td>
<td class="reg">${reg}</td>
<td class="route" title="${dest}">${dest||'â€“'}</td>
<td class="tcell"><span class="test">${toTime(disp)}</span>${delStr}</td>
<td class="tsch">${toTime(sch)}</td>
<td class="actype">${ac}</td>
<td><span class="sbadge ${sc}">${status}</span></td>`,fn,reg,sch,disp,delay,status,origin,dest,ac};
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CLEANUP OLD ROWS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function cleanup(tbody,stateMap){
  const now=Date.now()/1000;
  tbody.querySelectorAll('tr[data-fid]').forEach(r=>{
    const ref=parseInt(r.dataset.est)||parseInt(r.dataset.sch)||0;
    if(ref&&ref<now-14400){stateMap.delete(r.dataset.fid);r.remove();}
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SORT BY SCH TIME
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function sortBody(tbody){
  const rows=[...tbody.querySelectorAll('tr[data-sch]')];
  if(rows.length<2)return;
  rows.sort((a,b)=>(+a.dataset.sch||0)-(+b.dataset.sch||0));
  const f=document.createDocumentFragment();rows.forEach(r=>f.appendChild(r));tbody.appendChild(f);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   LOAD FLIGHTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadFlights(type,ts,wide=false){
  const mode=type==='arrivals'?'arrivals':'departures';
  const url=`${BASE_API}?code=${AIRPORT}&plugin-setting[schedule][mode]=${mode}&plugin-setting[schedule][timestamp]=${ts}&limit=100&plugin[]=schedule&page=1`;
  setDot('loading');
  const data=await fetchData(url);
  if(!data){setDot('error');return 0;}
  const sched=data?.result?.response?.airport?.pluginData?.schedule;
  if(!sched){setDot('error');return 0;}
  const items=(type==='arrivals'?sched.arrivals?.data:sched.departures?.data)||[];
  const tbody=document.getElementById(type==='arrivals'?'arrBody':'depBody');
  const stateMap=type==='arrivals'?arrState:depState;
  // Remove spinner placeholder
  const ph=tbody.querySelector('.empty-row');
  if(ph&&(ph.textContent.includes('Loading')||ph.textContent.includes('Initializing')))ph.remove();

  for(const item of items){
    const fl=item.flight||item;
    const fn=fl.identification?.number?.default||fl.identification?.callsign||'';
    if(!fn)continue;
    const code=getPrefix(fn);
    if(!ALLOWED.includes(code))continue;
    let sch,est,act;
    if(type==='arrivals'){sch=fl.time?.scheduled?.arrival;est=fl.time?.estimated?.arrival;act=fl.time?.real?.arrival;}
    else{sch=fl.time?.scheduled?.departure;est=fl.time?.estimated?.departure;act=fl.time?.real?.departure;}
    const ok=wide?withinWindowWide(sch,est,act):withinWindow(sch,est,act);
    if(!ok)continue;
    const fid=fl.identification?.id||(fn+'_'+sch);
    const disp=act||est||sch;
    const delay=delayMin(sch,disp);
    const status=fl.status?.text||'Scheduled';
    const cls=rowCls(status,delay);
    // Notify on delay change
    const prev=stateMap.get(fid);
    if(prev){
      if(delay>prev.delay){sendNotif(`âœˆ ${fn}: Delay increased`,`Now +${delay}m (was +${prev.delay}m)`);}
      else if(prev.delay===0&&delay>0){sendNotif(`âœˆ ${fn}: New delay`,`Delayed by ${delay} min`);}
    }
    stateMap.set(fid,{delay,status,fn,sch,disp});
    const built=buildRow(fl,type);
    let tr=tbody.querySelector(`tr[data-fid="${CSS.escape(fid)}"]`);
    if(tr){
      tr.className=cls;tr.dataset.sch=sch||'';tr.dataset.est=disp||'';tr.innerHTML=built.cells;
    }else{
      tr=document.createElement('tr');
      tr.className=cls;tr.dataset.fid=fid;tr.dataset.sch=sch||'';tr.dataset.est=disp||'';
      tr.innerHTML=built.cells;tbody.appendChild(tr);
    }
  }
  cleanup(tbody,stateMap);
  sortBody(tbody);
  const total=tbody.querySelectorAll('tr[data-fid]').length;
  if(total===0&&!tbody.querySelector('.empty-row')){
    tbody.innerHTML=`<tr class="empty-row"><td colspan="8">No ${type} found for permitted airlines.</td></tr>`;
  }
  setDot('live');updateCounts();updateLastUpdate();
  return total;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   LOAD EARLIER FLIGHTS
   Loads 12 hours earlier in 6h steps,
   uses wide window so old flights show.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadEarlier(){
  showToast('â® Loading earlier flightsâ€¦');
  // Go back 2 more 6h slots
  for(let i=0;i<2;i++){
    earliestTs-=21600;
    await Promise.all([
      loadFlights('arrivals',earliestTs,true),
      loadFlights('departures',earliestTs,true)
    ]);
  }
  buildTurnarounds();
  showToast('âœ… Earlier flights loaded');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   LOAD INITIAL WINDOW
   now-12h â†’ now+24h in 6h steps
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadInitialWindow(){
  const now=Math.floor(Date.now()/1000);
  baseTs=now;earliestTs=now-43200;
  const steps=[];
  for(let t=now-43200;t<=now+86400;t+=21600)steps.push(t);
  for(const ts of steps){
    await Promise.all([loadFlights('arrivals',ts,true),loadFlights('departures',ts,true)]);
  }
  buildTurnarounds();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   REFRESH
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function refresh(manual=false){
  if(isBusy&&!manual)return;
  isBusy=true;
  if(manual)showToast('ğŸ”„ Refreshingâ€¦');
  const now=Math.floor(Date.now()/1000);
  await Promise.all([loadFlights('arrivals',now),loadFlights('departures',now)]);
  buildTurnarounds();
  isBusy=false;nextCd=REFRESH_MS/1000;
}

function startTimers(){
  refreshTimer=setInterval(()=>refresh(),REFRESH_MS);
  cdTimer=setInterval(()=>{
    nextCd=Math.max(0,nextCd-1);
    const el=document.getElementById('refreshCountdown');
    if(el)el.textContent=`Refresh in ${nextCd}s`;
    if(nextCd<=0)nextCd=REFRESH_MS/1000;
  },1000);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TURNAROUND BUILDER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildTurnarounds(){
  const tb=document.getElementById('taBody');
  const aRows=[...document.querySelectorAll('#arrBody tr[data-fid]')];
  const dRows=[...document.querySelectorAll('#depBody tr[data-fid]')];
  if(!aRows.length||!dRows.length){
    tb.innerHTML='<tr class="empty-row"><td colspan="9">No turnaround matches yet.</td></tr>';
    document.getElementById('taCount').textContent='0';return;
  }
  const pairs=[];const usedDep=new Set();
  for(const ar of aRows){
    const reg=ar.querySelector('.reg')?.textContent?.trim();
    if(!reg||reg==='â€“')continue;
    const aEst=parseInt(ar.dataset.est)||parseInt(ar.dataset.sch)||0;
    if(!aEst)continue;
    let best=null,bestD=Infinity;
    for(const dr of dRows){
      if(usedDep.has(dr))continue;
      const dreg=dr.querySelector('.reg')?.textContent?.trim();
      if(dreg!==reg)continue;
      const dEst=parseInt(dr.dataset.est)||parseInt(dr.dataset.sch)||0;
      if(!dEst)continue;
      const diff=dEst-aEst;
      if(diff<=0||diff>9000)continue;
      if(diff<bestD){bestD=diff;best=dr;}
    }
    if(best){usedDep.add(best);pairs.push({ar,dr:best,reg});}
  }
  if(!pairs.length){
    tb.innerHTML='<tr class="empty-row"><td colspan="9">No turnaround flights found (same reg, dep within 2.5h of arr).</td></tr>';
    document.getElementById('taCount').textContent='0';return;
  }
  pairs.sort((a,b)=>(parseInt(a.ar.dataset.sch)||0)-(parseInt(b.ar.dataset.sch)||0));
  const frag=document.createDocumentFragment();
  for(const {ar,dr,reg} of pairs){
    const atds=ar.querySelectorAll('td'),dtds=dr.querySelectorAll('td');
    const afn=ar.querySelector('.fnum')?.textContent?.trim()||'';
    const dfn=dr.querySelector('.fnum')?.textContent?.trim()||'';
    const from=atds[3]?.textContent?.trim()||'â€“';
    const to=dtds[3]?.textContent?.trim()||'â€“';
    const aEta=atds[4]?.querySelector('.test')?.textContent?.trim()||atds[4]?.textContent?.trim()||'â€“';
    const dEtd=dtds[4]?.querySelector('.test')?.textContent?.trim()||dtds[4]?.textContent?.trim()||'â€“';
    const aSta=atds[5]?.textContent?.trim()||'â€“';
    const dStd=dtds[5]?.textContent?.trim()||'â€“';
    const ac=atds[6]?.textContent?.trim()||dtds[6]?.textContent?.trim()||'â€“';
    const aStat=atds[7]?.querySelector('.sbadge')?.textContent?.trim()||'';
    const dStat=dtds[7]?.querySelector('.sbadge')?.textContent?.trim()||'';
    const ac_=ar.className,dc_=dr.className;
    const cls=(ac_==='cancelled'||dc_==='cancelled')?'cancelled':(ac_==='heavyDelay'||dc_==='heavyDelay')?'heavyDelay':(ac_==='delay'||dc_==='delay')?'delay':'onTime';
    const asc=sbCls(aStat),dsc=sbCls(dStat);
    const tr=document.createElement('tr');tr.className=cls;
    tr.innerHTML=`
<td class="logo-cell">${logoHtml(afn||dfn)}</td>
<td><div class="ta-fns"><span class="ta-fn">${afn}</span><span class="ta-fn2">â†³ ${dfn}</span></div></td>
<td class="reg">${reg}</td>
<td class="route">${from}</td>
<td class="route">${to}</td>
<td class="ta-times">${aEta}<span class="ta-sep">â”€â”€</span>${dEtd}</td>
<td class="ta-times" style="opacity:.65">${aSta}<span class="ta-sep">â”€â”€</span>${dStd}</td>
<td class="actype">${ac}</td>
<td><div style="display:flex;flex-direction:column;gap:2px"><span class="sbadge ${asc}">${aStat||'â€“'}</span><span class="sbadge ${dsc}">${dStat||'â€“'}</span></div></td>`;
    frag.appendChild(tr);
  }
  tb.innerHTML='';tb.appendChild(frag);
  document.getElementById('taCount').textContent=pairs.length;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   UI HELPERS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateCounts(){
  const a=document.querySelectorAll('#arrBody tr[data-fid]').length;
  const d=document.querySelectorAll('#depBody tr[data-fid]').length;
  document.getElementById('arrCount').textContent=a;
  document.getElementById('depCount').textContent=d;
  const s=document.getElementById('flightSummary');
  if(s)s.textContent=`ğŸ›¬ ${a} arr Â· ğŸ›« ${d} dep`;
}
function updateLastUpdate(){
  const el=document.getElementById('lastUpdate');if(!el)return;
  el.textContent='Updated '+new Date().toLocaleTimeString('en-IN',{timeZone:'Asia/Kolkata',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false})+' IST';
}
function setDot(s){
  const d=document.getElementById('liveDot');if(!d)return;
  d.className='dot'+(s==='live'?'':' '+s);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   NOTIFICATIONS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function enableNotifications(){
  if(!('Notification' in window)){showToast('âŒ Notifications not supported');return;}
  if(Notification.permission==='granted'){showToast('ğŸ”” Already enabled!');return;}
  Notification.requestPermission().then(p=>{
    const btn=document.getElementById('notifyBtn');
    if(p==='granted'){
      showToast('âœ… Notifications enabled!');
      btn.classList.add('notify-on');btn.title='Notifications On';
      new Notification('AIX Security â€“ COK',{body:'Flight delay alerts are now active.'});
    }else{showToast('âš ï¸ Permission denied');}
  });
}
function sendNotif(title,body){
  if(typeof Notification==='undefined'||Notification.permission!=='granted')return;
  try{new Notification(title,{body,tag:title});}catch(e){}
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   DARK MODE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function applyTheme(dark){
  const html=document.documentElement;
  const btn=document.getElementById('darkBtn');
  if(dark){html.dataset.theme='dark';if(btn)btn.textContent='â˜€ï¸';}
  else{delete html.dataset.theme;if(btn)btn.textContent='ğŸŒ™';}
}
function toggleDark(){
  const dark=document.documentElement.dataset.theme!=='dark';
  localStorage.setItem('aix-theme',dark?'dark':'light');
  applyTheme(dark);
}
// Init theme
(function(){
  const saved=localStorage.getItem('aix-theme');
  if(saved==='dark')applyTheme(true);
  else if(!saved&&window.matchMedia('(prefers-color-scheme:dark)').matches)applyTheme(true);
})();

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TOAST
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let toastTm;
function showToast(msg,dur=3200){
  const t=document.getElementById('toast');if(!t)return;
  t.textContent=msg;t.classList.add('show');
  clearTimeout(toastTm);toastTm=setTimeout(()=>t.classList.remove('show'),dur);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TABS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function switchTab(tab){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  document.getElementById('content-'+tab).classList.add('active');
  if(tab==='turnaround')buildTurnarounds();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   DEMO DATA  (API unavailable)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function injectDemo(){
  const now=Math.floor(Date.now()/1000);
  const arr=[
    {fn:'IX184',reg:'VT-IXB',from:'Dubai (DXB)',eta:now-3600,sta:now-3900,ac:'B738',status:'Landed'},
    {fn:'IX361',reg:'VT-IXD',from:'Abu Dhabi (AUH)',eta:now-1800,sta:now-1800,ac:'A320',status:'Landed'},
    {fn:'FZ4302',reg:'A6-FEZ',from:'Dubai (DXB)',eta:now+1800,sta:now+600,ac:'B738',status:'Delayed'},
    {fn:'J9451',reg:'9K-AKA',from:'Kuwait (KWI)',eta:now+3600,sta:now+3600,ac:'A320',status:'En Route'},
    {fn:'UL227',reg:'4R-ABA',from:'Colombo (CMB)',eta:now+7200,sta:now+7200,ac:'A320',status:'Scheduled'},
    {fn:'AK088',reg:'9M-AHB',from:'Kuala Lumpur (KUL)',eta:now+10800,sta:now+10800,ac:'A320',status:'Scheduled'},
    {fn:'IX362',reg:'VT-IXF',from:'Sharjah (SHJ)',eta:now-7200,sta:now-7200,ac:'B738',status:'Landed'},
    {fn:'IX185',reg:'VT-IXC',from:'Muscat (MCT)',eta:now-5400,sta:now-5400,ac:'A320',status:'Landed'},
  ];
  const dep=[
    {fn:'IX185',reg:'VT-IXB',to:'Dubai (DXB)',etd:now+600,std:now-2400,ac:'B738',status:'Boarding'},
    {fn:'IX362',reg:'VT-IXD',to:'Abu Dhabi (AUH)',etd:now+5400,std:now+3600,ac:'A320',status:'Scheduled'},
    {fn:'FZ4303',reg:'A6-FEZ',to:'Dubai (DXB)',etd:now+5400,std:now+3600,ac:'B738',status:'Delayed'},
    {fn:'J9452',reg:'9K-AKA',to:'Kuwait (KWI)',etd:now+7200,std:now+7200,ac:'A320',status:'Scheduled'},
    {fn:'UL228',reg:'4R-ABA',to:'Colombo (CMB)',etd:now+10800,std:now+10800,ac:'A320',status:'Scheduled'},
    {fn:'AK089',reg:'9M-AHB',to:'Kuala Lumpur (KUL)',etd:now+14400,std:now+14400,ac:'A320',status:'Scheduled'},
    {fn:'IX363',reg:'VT-IXF',to:'Sharjah (SHJ)',etd:now-5400,std:now-5400,ac:'B738',status:'Departed'},
    {fn:'IX186',reg:'VT-IXC',to:'Muscat (MCT)',etd:now-3600,std:now-3600,ac:'A320',status:'Departed'},
  ];
  function inj(data,tbody,type){
    data.forEach(d=>{
      const sch=type==='arrivals'?d.sta:d.std;
      const est=type==='arrivals'?d.eta:d.etd;
      const delay=delayMin(sch,est);
      const cls=rowCls(d.status,delay);
      const sc=sbCls(d.status);
      const lh=logoHtml(d.fn);
      const delStr=delay>0?`<span class="tdelay">+${delay}m late</span>`:'';
      const fid=d.fn+'_'+sch;
      const tr=document.createElement('tr');
      tr.className=cls;tr.dataset.fid=fid;tr.dataset.sch=sch||'';tr.dataset.est=est||'';
      if(type==='arrivals'){
        tr.innerHTML=`<td class="logo-cell">${lh}</td><td class="fnum">${d.fn}</td><td class="reg">${d.reg}</td><td class="route">${d.from}</td><td class="tcell"><span class="test">${toTime(est)}</span>${delStr}</td><td class="tsch">${toTime(sch)}</td><td class="actype">${d.ac}</td><td><span class="sbadge ${sc}">${d.status}</span></td>`;
      }else{
        tr.innerHTML=`<td class="logo-cell">${lh}</td><td class="fnum">${d.fn}</td><td class="reg">${d.reg}</td><td class="route">${d.to}</td><td class="tcell"><span class="test">${toTime(est)}</span>${delStr}</td><td class="tsch">${toTime(sch)}</td><td class="actype">${d.ac}</td><td><span class="sbadge ${sc}">${d.status}</span></td>`;
      }
      tbody.appendChild(tr);
    });
  }
  const ab=document.getElementById('arrBody'),db=document.getElementById('depBody');
  ab.innerHTML='';db.innerHTML='';
  inj(arr,ab,'arrivals');inj(dep,db,'departures');
  sortBody(ab);sortBody(db);
  updateCounts();updateLastUpdate();setDot('live');buildTurnarounds();
  showToast('â„¹ï¸ Demo data shown (API unavailable)');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MOBILE: add card-info row after each tr
   (runs after data loads)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function enhanceMobileCards(tbodyId){
  if(window.innerWidth>640)return;
  const tbody=document.getElementById(tbodyId);
  tbody.querySelectorAll('tr[data-fid]').forEach(tr=>{
    if(tr.querySelector('.card-info'))return;
    const reg=tr.querySelector('.reg')?.textContent?.trim()||'';
    const ac=tr.querySelector('.actype')?.textContent?.trim()||'';
    const info=document.createElement('td');
    info.className='card-info';info.colSpan=3;
    info.innerHTML=`<span class="card-reg">${reg}</span>${ac&&reg?' Â· ':''}<span>${ac}</span>`;
    tr.appendChild(info);
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   INIT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(async function init(){
  showToast('ğŸ”„ Loading flight dataâ€¦');
  try{
    await loadInitialWindow();
    const a=document.querySelectorAll('#arrBody tr[data-fid]').length;
    const d=document.querySelectorAll('#depBody tr[data-fid]').length;
    if(a===0&&d===0){injectDemo();}
    else{
      showToast(`âœ… ${a} arrivals Â· ${d} departures loaded`);
      enhanceMobileCards('arrBody');
      enhanceMobileCards('depBody');
    }
  }catch(e){console.error(e);injectDemo();}
  startTimers();
})();
</script>
</body>
</html>
